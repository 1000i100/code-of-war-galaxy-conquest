(function(){var n,o,t,r,e,a,u,p,i,l,s,h,f,c,m,w,g,d,v,M,x,P,E,y,b,D,z,I,T,q,U,$,j,k,A,B,C,F,G,H;k=0,o="a",h="e",b="n",m=13,P=!1,p=5,H=60,u=0,i="",x=0,z=[],w={},this.onmessage=function(n){return null!=n.data?(i="<br>Tour "+k+"<br>",x=n.data.playerId,w=n.data.galaxy,t(),z=[],M(),P&&(i=c()),postMessage({orders:z,consoleMessage:'<span style="color:white">'+i+"</span>",error:""}),k++):postMessage("data null")},M=function(){var n,o,t,e,u,p,l,s,h,c,m,v,M,x,y,b,D,z,T,U,$;try{if(h=E(),c=q(),null!==c&&c.length>0){for($=[],T=0,U=h.length;U>T;T++)s=h[T],D=g(s,c),y=D[Math.floor(Math.random()*D.length)],z=B(s,y),b=I(y,z),x=1+I(y,B(s,y)).population,s.population>x&&j(s,y,x),I(s,1).population>=s.maxPop&&(y=d(s,therPlanets),x=Math.min(s.population,1+I(y,B(s,y)).population),j(s,y,x)),u=C(s,F()),G(k,u).length&&(e=C(s),t=r(s),m=a(s),m.population=0,o=r(m),v=o.pertesEnnemi-t.pertesEnnemi,l=o.mesPertes-t.mesPertes,n=v-l,i+='<span class="bilan">'+n+" perteEnnemi:"+v+" mesPertes:"+l+"</span>",i+='<br/><span class="bilan">'+t.maProd+"->"+o.maProd+"</span>",n>0&&f(s)),I(s,2).population>=s.maxPop&&(y=d(s,c),x=Math.min(s.population,1+I(y,B(s,y)).population),j(s,y,x)),P?$.push(function(){var n,o,t,r;for(t=w.content,r=[],n=0,o=t.length;o>n;n++)M=t[n],M!==s?r.push(j(s,M,0)):r.push(void 0);return r}()):$.push(void 0);return $}}catch(A){return p=A,i+=p}},j=function(o,t,r){return z.push({sourceID:o.id,targetID:t.id,numUnits:r}),r?(w.fleet.push(new n(r,o,t,k)),o.population-=r):void 0},G=function(n,o){var t,r,e,a;for(null==o&&(o=w.fleet),t=[],e=0,a=o.length;a>e;e++)r=o[e],n===A(r)&&t.push(r);return t},f=function(n){var o;return o=v(n,T()),n.population?j(n,o,n.population):void 0},D=function(n,o){return Math.min(n.population+o*p,n.maxPop)},r=function(n,o){var t,r,a,u,p,i,l,s,h,f,c;for(null==o&&(o=m),a=n;n.ref;)n=n.ref;for(h=C(n),r=0,u=0,t=0,p=0,s=f=k,c=k+o;c>=k?c>=f:f>=c;s=c>=k?++f:--f)l=e(a,s,h),r+=l.mesPertes,u+=l.pertesEnnemi,t+=l.maProd,p+=l.prodEnnemi,a=l.planete;return i={planete:a,mesPertes:r,pertesEnnemi:u,maProd:t,prodEnnemi:p}},e=function(n,t,r){var e,u,i,s,f,c,m,w,g,d,v,M,x,P,E,b,D;for(i=t,f=a(n),e=0,m=0,u=0,w=0,o===l(f)&&(e=f.population),h===l(f)&&(m=f.population),x=G(i,r),v=y(x),M=F(x),P=0,b=v.length;b>P;P++)d=v[P],e+=d.crew,o===l(f)&&(f.population+=d.crew),o!==l(f)&&(f.population-=d.crew),f.population<0&&(f.owner=d.owner,f.population=-f.population);for(E=0,D=M.length;D>E;E++)d=M[E],m+=d.crew,h===l(f)&&(f.population+=d.crew),h!==l(f)&&(f.population-=d.crew),f.population<0&&(f.owner=d.owner,f.population=-f.population);return o===l(f)&&(u+=Math.max(0,Math.min(p,f.popMax-f.population))),h===l(f)&&(w+=Math.max(0,Math.min(p,f.popMax-f.population))),f.population+=p,f.population>f.popMax&&(f.population=f.popMax),o===l(f)?(s=e-f.population,c=m):h===l(f)?(s=e,c=m-f.population):(s=e,c=m),g={planete:f,mesPertes:s,pertesEnnemi:c,maProd:u,prodEnnemi:w}},a=function(n){var o;return o={size:n.size,population:n.population,maxPop:$(n),owner:n.owner,id:n.id,x:n.x,y:n.y,ref:n}},I=function(n,o){var t,r,e,u,i,l,s,h;for(r=a(n),e=r.population-5,t=C(r.ref),i=l=0;o>=0?o>=l:l>=o;i=o>=0?++l:--l){for(s=0,h=t.length;h>s;s++)u=t[s],A(u)===k+i&&(u.owner===r.owner?e=Math.min(e+u.crew,r.maxPop):(e-=u.crew,0>e&&(e=-e,r.owner=u.owner)));e=Math.min(e+p,r.maxPop)}return r.population=e,r},A=function(n){return n.creationTurn+n.travelDuration},C=function(n,o){var t,r,e,a;for(null==o&&(o=w.fleet),t=[],e=0,a=o.length;a>e;e++)r=o[e],r.target===n&&t.push(r);return t},v=function(n,o){var t,r,e,a,u,p;for(a=o[0],t=s(n,a),u=0,p=o.length;p>u;u++)e=o[u],r=s(n,e),t>r&&r>0&&(t=r,a=e);return a},d=function(n,o){var t,r,e,a,u,p,i,l;for(o||(o=w.content),u=o[0],p=B(n,o[0]),a=I(u,p),e=a.owner===u.owner?a.population:9999,i=0,l=o.length;l>i;i++)r=o[i],p=B(n,r),a=I(r,p),t=a.owner===r.owner?a.population:9999,e>t&&(e=t,u=r);return u},g=function(n,o){var t,r,e,a,u,p,i,l,s;for(r=d(n,o),i=B(n,r),u=I(r,i),a=u.owner===r.owner?u.population:9999,p=[],l=0,s=o.length;s>l;l++)e=o[l],i=B(n,e),u=I(e,i),t=u.owner===e.owner?u.population:9999,a+10>=t&&p.push(e);return p},n=function(){function n(n,o,t,r){this.crew=n,this.source=o,this.target=t,this.creationTurn=r,this.owner=o.owner,this.travelDuration=Math.ceil(s(o,t)/H)}return n}(),l=function(n){return 13421772===n.owner.color?b:n.owner.id===x?o:h},E=function(n){var t,r,e,a;for(null==n&&(n=w.content),r=[],e=0,a=n.length;a>e;e++)t=n[e],l(t)===o&&r.push(t);return r},T=function(n){var o,t,r,e;for(null==n&&(n=w.content),t=[],r=0,e=n.length;e>r;r++)o=n[r],l(o)===h&&t.push(o);return t},U=function(n){var o,t,r,e;for(null==n&&(n=w.content),t=[],r=0,e=n.length;e>r;r++)o=n[r],l(o)===b&&t.push(o);return t},q=function(n){var t,r,e,a;for(null==n&&(n=w.content),r=[],e=0,a=n.length;a>e;e++)t=n[e],l(t)!==o&&r.push(t);return r},y=function(n){var o,t,r,e;for(null==n&&(n=w.fleet),o=[],r=0,e=n.length;e>r;r++)t=n[r],t.owner.id===x&&t.crew>0&&o.push(t);return o},F=function(n){var o,t,r,e;for(null==n&&(n=w.fleet),o=[],r=0,e=n.length;e>r;r++)t=n[r],t.owner.id!==x&&t.crew>0&&o.push(t);return o},B=function(n,o){return Math.ceil(s(n,o)/H)},s=function(n,o){return Math.sqrt(Math.pow(o.x-n.x,2)+Math.pow(o.y-n.y,2))},t=function(){var n,o,t,r,e;for(r=w.content,e=[],o=0,t=r.length;t>o;o++)n=r[o],e.push(n.maxPop=$(n));return e},$=function(n){return Math.max(50,100*(n.size-1))},c=function(){var n,o,t,r,e;for(t=140,n="#?!§*$£¤&@%µ#!¤#",r="",o=e=0;t>=0?t>=e:e>=t;o=t>=0?++e:--e)r+=n.substr(Math.floor(Math.random()*n.length),1);return r}}).call(this);