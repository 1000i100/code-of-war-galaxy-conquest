(function(){var n,t,e,r,o,i,u,a,l,s,c,f,h,p,g,w,M,A,T,E,L,D,_,P,d,v,y,U,x,N,m,I,G;w=0,A="",x=0,g=0,p="a",T="e",m="n",L=13,N=!1,M=5,this.onmessage=function(n){var t;return null!=n.data?(t=n.data,x=t.playerId,postMessage(new f(d(t.galaxy),A))):postMessage("data null")},d=function(n){var t,o,u,a,l,s,c,f,h,p,w,M,T,L,P,d,m,I,S,B,F,H,O,R,z,X,b,k;for(A="<br>Tour "+g+"<br>",b=n.content,m=0,F=b.length;F>m;m++)c=b[m],A+=v(c)+",";w=[];try{if(l=e.getPlayerPlanets(x,n),s=e.getEnnemyPlanets(x,n),null!==s&&s.length>0)for(I=0,H=l.length;H>I;I++){for(a=l[I],P=D(a,n,s),T=P[Math.floor(Math.random()*P.length)],d=e.getTravelNumTurn(a,T),L=G(T,n,d),h=1+G(T,n,e.getTravelNumTurn(a,T)).population,a.population>h&&(w.push(new r(a.id,T.id,h)),a.population-=h),G(a,n,1).population>=i.getMaxPopulation(a.size)&&(T=_(a,n,s),h=Math.min(a.population,1+G(T,n,e.getTravelNumTurn(a,T)).population),w.push(new r(a.id,T.id,h)),a.population-=h),t=y(a,e.getEnnemyFleets(x,n)),u=!1,S=0,O=t.length;O>S;S++)M=t[S],1===U(M)-g&&(u=!0);if(u){for(p=0,B=0,R=t.length;R>B;B++)M=t[B],p+=M.crew;p>i.getMaxPopulation(a.size)&&(w=E(a,n,w))}if(G(a,n,1).population>=i.getMaxPopulation(a.size)&&(T=_(a,n,s),h=Math.min(a.population,1+G(T,n,e.getTravelNumTurn(a,T)).population),w.push(new r(a.id,T.id,h))),N)for(k=n.content,X=0,z=k.length;z>X;X++)f=k[X],f!==a&&w.push(new r(a.id,f.id,0))}}catch(q){o=q,A+=o}return g++,w},E=function(n,t,e){var o;return o=P(n,t.content),e.push(new r(n.id,o.id,n.population)),e},I=function(n,t){return Math.min(n.population+t*M,i.getMaxPopulation(n.size))},G=function(n,t,e){var r,o,u,a,l,s,c,f;for(o={size:n.size,population:n.population,owner:n.owner,id:n.id,x:n.x,y:n.y,ref:n},u=o.population-5,r=y(o.ref,t.fleet),l=s=0;e>=0?e>=s:s>=e;l=e>=0?++s:--s){for(c=0,f=r.length;f>c;c++)a=r[c],U(a)===g+l&&(a.owner===o.owner?u=Math.min(u+a.crew,i.getMaxPopulation(o.size)):(u-=a.crew,0>u&&(u=-u,o.owner=a.owner)));u=Math.min(u+M,i.getMaxPopulation(o.size))}return o.population=u,o},v=function(n){return 13421772===n.owner.color?m:n.owner.id===x?p:T},U=function(n){return n.creationTurn+n.travelDuration},y=function(n,t){var e,r,o,i;for(e=[],o=0,i=t.length;i>o;o++)r=t[o],r.target===n&&e.push(r);return e},P=function(n,t){var r,o,i,u,l,s;for(u=t[0],r=e.getDistanceBetween(new a(n.x,n.y),new a(u.x,u.y)),l=0,s=t.length;s>l;l++)i=t[l],o=e.getDistanceBetween(new a(n.x,n.y),new a(i.x,i.y)),r>o&&(r=o,u=i);return u},_=function(n,t,r){var o,i,u,a,l,s,c,f;for(r||(r=t.content),l=r[0],s=e.getTravelNumTurn(n,r[0]),a=G(l,t,s),u=a.owner===l.owner?a.population:9999,c=0,f=r.length;f>c;c++)i=r[c],s=e.getTravelNumTurn(n,i),a=G(i,t,s),o=a.owner===i.owner?a.population:9999,u>o&&(u=o,l=i);return l},D=function(n,t,r){var o,i,u,a,l,s,c,f,h;for(i=_(n,t,r),c=e.getTravelNumTurn(n,i),l=G(i,t,c),a=l.owner===i.owner?l.population:9999,s=[],f=0,h=r.length;h>f;f++)u=r[f],c=e.getTravelNumTurn(n,u),l=G(u,t,c),o=l.owner===u.owner?l.population:9999,a+10>=o&&s.push(u);return s},n=function(){function n(n,t){this.width=n,this.height=t,this.content=[],this.fleet=[]}return n}(),l=function(){function n(n,t){this.from=n,this.to=t}return n}(),r=function(){function n(n,t,e){this.sourceID=n,this.targetID=t,this.numUnits=e}return n}(),o=function(){function n(n,t,e,r){this.x=n,this.y=t,this.size=e,this.owner=r,this.population=i.getDefaultPopulation(e),this.id=h.get()}return n}(),s=function(){function n(n,r,o,i){this.crew=n,this.source=r,this.target=o,this.creationTurn=i,this.owner=r.owner,this.travelDuration=Math.ceil(e.getDistanceBetween(new a(r.x,r.y),new a(o.x,o.y))/t.SHIP_SPEED)}return n}(),c=function(){function n(n,t){this.playerId=n,this.galaxy=t}return n}(),f=function(){function n(n,t){this.orders=n,this.consoleMessage=null!=t?t:"",this.error=""}return n}(),a=function(){function n(n,t){this.x=n,this.y=t}return n}(),e=function(){function n(){}return n.getDistanceBetween=function(n,t){return Math.sqrt(Math.pow(t.x-n.x,2)+Math.pow(t.y-n.y,2))},n.getPlayerPlanets=function(n,t){var e,r,o,i,u;for(r=[],u=t.content,o=0,i=u.length;i>o;o++)e=u[o],e.owner.id===n&&r.push(e);return r},n.getEnnemyPlanets=function(n,t){var e,r,o,i,u;for(r=[],u=t.content,o=0,i=u.length;i>o;o++)e=u[o],e.owner.id!==n&&r.push(e);return r},n.getEnnemyFleets=function(n,t){var e,r,o,i,u;for(e=[],u=t.fleet,o=0,i=u.length;i>o;o++)r=u[o],r.owner.id!==n&&e.push(r);return e},n.getMyFleets=function(n,t){var e,r,o,i,u;for(e=[],u=t.fleet,o=0,i=u.length;i>o;o++)r=u[o],r.owner.id===n&&e.push(r);return e},n.getTravelNumTurn=function(e,r){return Math.ceil(n.getDistanceBetween(new a(e.x,e.y),new a(r.x,r.y))/t.SHIP_SPEED)},n}(),h=function(){function n(){}return n.lastUID=0,n.get=function(){return n.lastUID++,n.lastUID},n}(),t=function(){function n(){}return n.DEFAULT_PLAYER_POPULATION=100,n.NUM_PLANET=new l(5,10),n.PLANET_GROWTH=5,n.SHIP_SPEED=60,n.GAME_SPEED=500,n.GAME_DURATION=240,n.GAME_MAX_NUM_TURN=500,n}(),i=function(){function n(){}return n.DEFAULT_SMALL=20,n.DEFAULT_NORMAL=30,n.DEFAULT_BIG=40,n.DEFAULT_HUGE=50,n.MAX_SMALL=50,n.MAX_NORMAL=100,n.MAX_BIG=200,n.MAX_HUGE=300,n.getMaxPopulation=function(t){var e;switch(e=1,t){case u.SMALL:e=n.MAX_SMALL;break;case u.NORMAL:e=n.MAX_NORMAL;break;case u.BIG:e=n.MAX_BIG;break;case u.HUGE:e=n.MAX_HUGE}return e},n.getDefaultPopulation=function(t){var e;switch(e=1,t){case u.SMALL:e=n.DEFAULT_SMALL;break;case u.NORMAL:e=n.DEFAULT_NORMAL;break;case u.BIG:e=n.DEFAULT_BIG;break;case u.HUGE:e=n.DEFAULT_HUGE}return e},n}(),u=function(){function n(){}return n.SMALL=1,n.NORMAL=2,n.BIG=3,n.HUGE=4,n}()}).call(this);