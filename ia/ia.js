(function(){var n,o,t,r,e,a,p,u,i,l,s,f,h,c,m,w,g,d,M,v,x,P,E,y,b,D,z,I,T,q,U,$,j,k,A,B,C,F,G,H;k=0,o="a",f="e",b="n",m=13,P=!0,u=5,H=60,p=0,i="",x=0,z=[],w={},this.onmessage=function(n){return null!=n.data?(i="<br>Tour "+k+"<br>",x=n.data.playerId,w=n.data.galaxy,t(),z=[],v(),P&&(i=c()),postMessage({orders:z,consoleMessage:'<span style="color:white">'+i+"</span>",error:""}),k++):postMessage("data null")},v=function(){var n,o,t,e,p,u,s,c,m,w,v,x,P,y,b,D,z,U,$,H,J,K,L,N,O,Q;try{if(s=F(),s.length>0)for(K=0,N=s.length;N>K;K++)J=s[K],b=J.target,m=M(b,E()),$=B(m,b),U=A(J)-k,$>=U&&10>k&&(D=I(b,$),f===l(D)&&(y=1+D.population,m.population>y&&j(m,b,y))),$>=U&&U>=$-3&&(D=I(b,$),f===l(D)&&(y=1+D.population,m.population>y&&j(m,b,y)));if(3>k)return 0;if(w=E(),v=20>k?T():q(),null!==v&&v.length>0){for(Q=[],L=0,O=w.length;O>L;L++)m=w[L],z=g(m,v),b=z[Math.floor(Math.random()*z.length)],H=B(m,b),D=I(b,H),y=1+I(b,B(m,b)).population,m.population>y&&j(m,b,y),I(m,1).population>=m.maxPop&&(b=d(m,T()),y=Math.min(m.population,1+I(b,B(m,b)).population),j(m,b,y)),p=C(m,F()),G(k,p).length&&(e=C(m),t=r(m),x=a(m),x.population=0,o=r(x),P=o.pertesEnnemi-t.pertesEnnemi,c=o.mesPertes-t.mesPertes,n=P-c,i+='<span class="bilan">'+n+" perteEnnemi:"+P+" mesPertes:"+c+"</span>",i+='<br/><span class="bilan">'+t.maProd+"->"+o.maProd+"</span>",n>0&&h(m)),I(m,2).population>=m.maxPop?(b=d(m,v),y=Math.min(m.population,1+I(b,B(m,b)).population),Q.push(j(m,b,y))):Q.push(void 0);return Q}}catch(R){return u=R,i+=u}},j=function(o,t,r){return z.push({sourceID:o.id,targetID:t.id,numUnits:r}),r?(w.fleet.push(new n(r,o,t,k)),o.population-=r):void 0},G=function(n,o){var t,r,e,a;for(null==o&&(o=w.fleet),t=[],e=0,a=o.length;a>e;e++)r=o[e],n===A(r)&&t.push(r);return t},h=function(n){var o;return o=M(n,T()),n.population?j(n,o,n.population):void 0},D=function(n,o){return Math.min(n.population+o*u,n.maxPop)},r=function(n,o){var t,r,a,p,u,i,l,s,f,h,c;for(null==o&&(o=m),a=n;n.ref;)n=n.ref;for(f=C(n),r=0,p=0,t=0,u=0,s=h=k,c=k+o;c>=k?c>=h:h>=c;s=c>=k?++h:--h)l=e(a,s,f),r+=l.mesPertes,p+=l.pertesEnnemi,t+=l.maProd,u+=l.prodEnnemi,a=l.planete;return i={planete:a,mesPertes:r,pertesEnnemi:p,maProd:t,prodEnnemi:u}},e=function(n,t,r){var e,p,i,s,h,c,m,w,g,d,M,v,x,P,E,b,D;for(i=t,h=a(n),e=0,m=0,p=0,w=0,o===l(h)&&(e=h.population),f===l(h)&&(m=h.population),x=G(i,r),M=y(x),v=F(x),P=0,b=M.length;b>P;P++)d=M[P],e+=d.crew,o===l(h)&&(h.population+=d.crew),o!==l(h)&&(h.population-=d.crew),h.population<0&&(h.owner=d.owner,h.population=-h.population);for(E=0,D=v.length;D>E;E++)d=v[E],m+=d.crew,f===l(h)&&(h.population+=d.crew),f!==l(h)&&(h.population-=d.crew),h.population<0&&(h.owner=d.owner,h.population=-h.population);return o===l(h)&&(p+=Math.max(0,Math.min(u,h.popMax-h.population))),f===l(h)&&(w+=Math.max(0,Math.min(u,h.popMax-h.population))),h.population+=u,h.population>h.popMax&&(h.population=h.popMax),o===l(h)?(s=e-h.population,c=m):f===l(h)?(s=e,c=m-h.population):(s=e,c=m),g={planete:h,mesPertes:s,pertesEnnemi:c,maProd:p,prodEnnemi:w}},a=function(n){var o;return o={size:n.size,population:n.population,maxPop:$(n),owner:n.owner,id:n.id,x:n.x,y:n.y,ref:n}},I=function(n,o){var t,r,e,p,i,l,s,f;for(r=a(n),e=r.population-5,t=C(r.ref),i=l=0;o>=0?o>=l:l>=o;i=o>=0?++l:--l){for(s=0,f=t.length;f>s;s++)p=t[s],A(p)===k+i&&(p.owner===r.owner?e=Math.min(e+p.crew,r.maxPop):(e-=p.crew,0>e&&(e=-e,r.owner=p.owner)));e=Math.min(e+u,r.maxPop)}return r.population=e,r},A=function(n){return n.creationTurn+n.travelDuration},C=function(n,o){var t,r,e,a;for(null==o&&(o=w.fleet),t=[],e=0,a=o.length;a>e;e++)r=o[e],r.target===n&&t.push(r);return t},M=function(n,o){var t,r,e,a,p,u;for(a=o[0],t=s(n,a),p=0,u=o.length;u>p;p++)e=o[p],r=s(n,e),t>r&&r>0&&(t=r,a=e);return a},d=function(n,o){var t,r,e,a,p,u,i,l;for(o||(o=w.content),p=o[0],u=B(n,o[0]),a=I(p,u),e=a.owner===p.owner?a.population:9999,i=0,l=o.length;l>i;i++)r=o[i],u=B(n,r),a=I(r,u),t=a.owner===r.owner?a.population:9999,e>t&&(e=t,p=r);return p},g=function(n,o){var t,r,e,a,p,u,i,l,s;for(r=d(n,o),i=B(n,r),p=I(r,i),a=p.owner===r.owner?p.population:9999,u=[],l=0,s=o.length;s>l;l++)e=o[l],i=B(n,e),p=I(e,i),t=p.owner===e.owner?p.population:9999,a+10>=t&&u.push(e);return u},n=function(){function n(n,o,t,r){this.crew=n,this.source=o,this.target=t,this.creationTurn=r,this.owner=o.owner,this.travelDuration=Math.ceil(s(o,t)/H)}return n}(),l=function(n){return 13421772===n.owner.color?b:n.owner.id===x?o:f},E=function(n){var t,r,e,a;for(null==n&&(n=w.content),r=[],e=0,a=n.length;a>e;e++)t=n[e],l(t)===o&&r.push(t);return r},T=function(n){var o,t,r,e;for(null==n&&(n=w.content),t=[],r=0,e=n.length;e>r;r++)o=n[r],l(o)===f&&t.push(o);return t},U=function(n){var o,t,r,e;for(null==n&&(n=w.content),t=[],r=0,e=n.length;e>r;r++)o=n[r],l(o)===b&&t.push(o);return t},q=function(n){var t,r,e,a;for(null==n&&(n=w.content),r=[],e=0,a=n.length;a>e;e++)t=n[e],l(t)!==o&&r.push(t);return r},y=function(n){var o,t,r,e;for(null==n&&(n=w.fleet),o=[],r=0,e=n.length;e>r;r++)t=n[r],t.owner.id===x&&t.crew>0&&o.push(t);return o},F=function(n){var o,t,r,e;for(null==n&&(n=w.fleet),o=[],r=0,e=n.length;e>r;r++)t=n[r],t.owner.id!==x&&t.crew>0&&o.push(t);return o},B=function(n,o){return Math.ceil(s(n,o)/H)},s=function(n,o){return Math.sqrt(Math.pow(o.x-n.x,2)+Math.pow(o.y-n.y,2))},t=function(){var n,o,t,r,e;for(r=w.content,e=[],o=0,t=r.length;t>o;o++)n=r[o],e.push(n.maxPop=$(n));return e},$=function(n){return Math.max(50,100*(n.size-1))},c=function(){var n,o,t,r,e;for(t=140,n="#?!§*$£¤&@%µ#!¤#",r="",o=e=0;t>=0?t>=e:e>=t;o=t>=0?++e:--e)r+=n.substr(Math.floor(Math.random()*n.length),1);return r}}).call(this);