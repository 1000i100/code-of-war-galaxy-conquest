(function(){var n,t,e,r,o,i,u,a,l,s,c,f,h,p,g,w,M,A,T,E,L,D,_,P,v,y,U,d,x,N,m,I;w=0,A="",x=0,g=0,p="a",T="e",N="n",L=13,M=5,this.onmessage=function(n){var t;return null!=n.data?(t=n.data,x=t.playerId,postMessage(new f(v(t.galaxy),A))):postMessage("data null")},v=function(n){var t,o,u,a,l,s,c,f,h,p,w,M,T,L,P,v,N,m,G,S,B,F,H,O;for(A="<br>Tour "+g+"<br>",O=n.content,v=0,S=O.length;S>v;v++)c=O[v],A+=y(c)+",";p=[];try{if(l=e.getPlayerPlanets(x,n),s=e.getEnnemyPlanets(x,n),null!==s&&s.length>0)for(N=0,B=l.length;B>N;N++){for(a=l[N],L=D(a,n,s),M=L[Math.floor(Math.random()*L.length)],P=e.getTravelNumTurn(a,M),T=I(M,n,P),f=1+I(M,n,e.getTravelNumTurn(a,M)).population,a.population>f&&(p.push(new r(a.id,M.id,f)),a.population-=f),I(a,n,1).population>=i.getMaxPopulation(a.size)&&(M=_(a,n,s),f=Math.min(a.population,1+I(M,n,e.getTravelNumTurn(a,M)).population),p.push(new r(a.id,M.id,f)),a.population-=f),t=U(a,e.getEnnemyFleets(x,n)),u=!1,m=0,F=t.length;F>m;m++)w=t[m],1===d(w)-g&&(u=!0);if(u){for(h=0,G=0,H=t.length;H>G;G++)w=t[G],h+=w.crew;h>i.getMaxPopulation(a.size)&&(p=E(a,n,p))}I(a,n,1).population>=i.getMaxPopulation(a.size)&&(M=_(a,n,s),f=Math.min(a.population,1+I(M,n,e.getTravelNumTurn(a,M)).population),p.push(new r(a.id,M.id,f)))}}catch(R){o=R,A+=o}return g++,p},E=function(n,t,e){var o;return o=P(n,t.content),e.push(new r(n.id,o.id,n.population)),e},m=function(n,t){return Math.min(n.population+t*M,i.getMaxPopulation(n.size))},I=function(n,t,e){var r,o,u,a,l,s,c,f;for(o={size:n.size,population:n.population,owner:n.owner,id:n.id,x:n.x,y:n.y,ref:n},u=o.population-5,r=U(o.ref,t.fleet),l=s=0;e>=0?e>=s:s>=e;l=e>=0?++s:--s){for(c=0,f=r.length;f>c;c++)a=r[c],d(a)===g+l&&(a.owner===o.owner?u=Math.min(u+a.crew,i.getMaxPopulation(o.size)):(u-=a.crew,0>u&&(u=-u,o.owner=a.owner)));u=Math.min(u+M,i.getMaxPopulation(o.size))}return o.population=u,o},y=function(n){return 13421772===n.owner.color?N:n.owner.id===x?p:T},d=function(n){return n.creationTurn+n.travelDuration},U=function(n,t){var e,r,o,i;for(e=[],o=0,i=t.length;i>o;o++)r=t[o],r.target===n&&e.push(r);return e},P=function(n,t){var r,o,i,u,l,s;for(u=t[0],r=e.getDistanceBetween(new a(n.x,n.y),new a(u.x,u.y)),l=0,s=t.length;s>l;l++)i=t[l],o=e.getDistanceBetween(new a(n.x,n.y),new a(i.x,i.y)),r>o&&(r=o,u=i);return u},_=function(n,t,r){var o,i,u,a,l,s,c,f;for(r||(r=t.content),l=r[0],s=e.getTravelNumTurn(n,r[0]),a=I(l,t,s),u=a.owner===l.owner?a.population:9999,c=0,f=r.length;f>c;c++)i=r[c],s=e.getTravelNumTurn(n,i),a=I(i,t,s),o=a.owner===i.owner?a.population:9999,u>o&&(u=o,l=i);return l},D=function(n,t,r){var o,i,u,a,l,s,c,f,h;for(i=_(n,t,r),c=e.getTravelNumTurn(n,i),l=I(i,t,c),a=l.owner===i.owner?l.population:9999,s=[],f=0,h=r.length;h>f;f++)u=r[f],c=e.getTravelNumTurn(n,u),l=I(u,t,c),o=l.owner===u.owner?l.population:9999,a+10>=o&&s.push(u);return s},n=function(){function n(n,t){this.width=n,this.height=t,this.content=[],this.fleet=[]}return n}(),l=function(){function n(n,t){this.from=n,this.to=t}return n}(),r=function(){function n(n,t,e){this.sourceID=n,this.targetID=t,this.numUnits=e}return n}(),o=function(){function n(n,t,e,r){this.x=n,this.y=t,this.size=e,this.owner=r,this.population=i.getDefaultPopulation(e),this.id=h.get()}return n}(),s=function(){function n(n,r,o,i){this.crew=n,this.source=r,this.target=o,this.creationTurn=i,this.owner=r.owner,this.travelDuration=Math.ceil(e.getDistanceBetween(new a(r.x,r.y),new a(o.x,o.y))/t.SHIP_SPEED)}return n}(),c=function(){function n(n,t){this.playerId=n,this.galaxy=t}return n}(),f=function(){function n(n,t){this.orders=n,this.consoleMessage=null!=t?t:"",this.error=""}return n}(),a=function(){function n(n,t){this.x=n,this.y=t}return n}(),e=function(){function n(){}return n.getDistanceBetween=function(n,t){return Math.sqrt(Math.pow(t.x-n.x,2)+Math.pow(t.y-n.y,2))},n.getPlayerPlanets=function(n,t){var e,r,o,i,u;for(r=[],u=t.content,o=0,i=u.length;i>o;o++)e=u[o],e.owner.id===n&&r.push(e);return r},n.getEnnemyPlanets=function(n,t){var e,r,o,i,u;for(r=[],u=t.content,o=0,i=u.length;i>o;o++)e=u[o],e.owner.id!==n&&r.push(e);return r},n.getEnnemyFleets=function(n,t){var e,r,o,i,u;for(e=[],u=t.fleet,o=0,i=u.length;i>o;o++)r=u[o],r.owner.id!==n&&e.push(r);return e},n.getMyFleets=function(n,t){var e,r,o,i,u;for(e=[],u=t.fleet,o=0,i=u.length;i>o;o++)r=u[o],r.owner.id===n&&e.push(r);return e},n.getTravelNumTurn=function(e,r){return Math.ceil(n.getDistanceBetween(new a(e.x,e.y),new a(r.x,r.y))/t.SHIP_SPEED)},n}(),h=function(){function n(){}return n.lastUID=0,n.get=function(){return n.lastUID++,n.lastUID},n}(),t=function(){function n(){}return n.DEFAULT_PLAYER_POPULATION=100,n.NUM_PLANET=new l(5,10),n.PLANET_GROWTH=5,n.SHIP_SPEED=60,n.GAME_SPEED=500,n.GAME_DURATION=240,n.GAME_MAX_NUM_TURN=500,n}(),i=function(){function n(){}return n.DEFAULT_SMALL=20,n.DEFAULT_NORMAL=30,n.DEFAULT_BIG=40,n.DEFAULT_HUGE=50,n.MAX_SMALL=50,n.MAX_NORMAL=100,n.MAX_BIG=200,n.MAX_HUGE=300,n.getMaxPopulation=function(t){var e;switch(e=1,t){case u.SMALL:e=n.MAX_SMALL;break;case u.NORMAL:e=n.MAX_NORMAL;break;case u.BIG:e=n.MAX_BIG;break;case u.HUGE:e=n.MAX_HUGE}return e},n.getDefaultPopulation=function(t){var e;switch(e=1,t){case u.SMALL:e=n.DEFAULT_SMALL;break;case u.NORMAL:e=n.DEFAULT_NORMAL;break;case u.BIG:e=n.DEFAULT_BIG;break;case u.HUGE:e=n.DEFAULT_HUGE}return e},n}(),u=function(){function n(){}return n.SMALL=1,n.NORMAL=2,n.BIG=3,n.HUGE=4,n}()}).call(this);