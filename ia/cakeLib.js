(function(){var e,r,t,n,o,i,u,s,l,p,a,c,f,m,v,x,d,h,g,D,y,T,w,q,C,S,j,k,b,F,L,R,P,E,N,O,$,_,z,A,B,G,H,I,J,K,M,Q,U;d=require("fs"),k=require("path"),U=require("child_process"),f=U.exec,_=U.spawn,K=require("util"),Q=require("watch"),y=require("glob"),t=require("q"),s=require("coffee-script"),j=require("mkdirp"),e=require("mocha"),i=require("chai"),u=require("chai-as-promised"),L=require("rimraf"),C=require("livereload"),n=require("uglify-js"),require("colors"),J=!1,M=!1,a=!1,exports.appSourceDir="",exports.appCompiledDir="",exports.appTestablePattern="",exports.specDir="",exports.specCompiledDir="",exports.oneShotReporter="nyan",exports.watchReporter="min",exports.runTestDelay=500,exports.reglesDeConversion={},exports.aDeplacer=[],exports.watchTask=function(e){return $(e),t(exports.buildTask(e)).then(function(){var t;return exports.testTask(e),new r(exports.appSourceDir,o,o,R),new r(exports.specDir,z,z,N),t=C.createServer({interval:exports.runTestDelay}),t.watch(k.resolve(".",exports.appCompiledDir))})},exports.testTask=function(r,n){var o;return null==n&&(n=exports.oneShotReporter),o=t.defer(),$(r),a&&K.log("Préparation des tests".cyan),i.use(u).should(),H(exports.appTestablePattern,F).then(function(){var r,t;return r=new e,r.reporter(n),t=exports.specCompiledDir+"**/*.js",a&&K.log("Liste les fichiers répondant au motif ".cyan+t),y(t,function(e,t){var n,i,u,s;for(u=0,s=t.length;s>u;u++)n=t[u],a&&K.log("spec : ".cyan+n),delete require.cache[k.resolve(".",n)],r.addFile(n);return M&&K.log("Execution des tests".cyan),i=r.run(function(){return M&&K.log("Tests terminés".cyan),o.resolve()})})}),o.promise},exports.buildTask=function(e){var r;return r=t.defer(),$(e),t.all([exports.aDeplacer.length?q(exports.aDeplacer,B):void 0,H(exports.specDir+"**",l,[exports.specDir,exports.specCompiledDir]),H(exports.appSourceDir+"**",l,[exports.appSourceDir,exports.appCompiledDir])]).done(function(){return K.log("Compilation terminée".cyan),r.resolve()}),r.promise},exports.cleanTask=function(e){return $(e),K.log("Nétoyage du projet...".cyan),t.all([E(exports.specCompiledDir),E(exports.appCompiledDir)]).done(function(){return K.log("Nétoyage Terminé".cyan)})},exports.coffee2js=function(e){var r,o;return o=t.defer(),r=s.compile(e),r=n.minify(r+"",{fromString:!0}).code,o.resolve(r),o.promise},o=function(e){return l(e,exports.appSourceDir,exports.appCompiledDir).then(function(){return J=!0,setTimeout(O,exports.runTestDelay)})},z=function(e){return l(e,exports.specDir,exports.specCompiledDir).then(function(){return J=!0,setTimeout(O,exports.runTestDelay)})},N=function(e){return P(e,exports.specDir,exports.specCompiledDir).then(function(){return J=!0,setTimeout(O,exports.runTestDelay)})},R=function(e){return P(e).then(function(){return J=!0,setTimeout(O,exports.runTestDelay)})},H=function(e,r,n){var o,i;return null==n&&(n=[]),i=t.defer(),o=(r+"").split("{")[0],a&&K.log("execute ".yellow+o+" sur chaque fichiers répondant au motif : ".yellow+e),y(e,function(t,u){var s;return t&&i.reject(t),u.length?(s=q(u,r,n),s.then(function(){return i.resolve(o)})):i.reject("no file matching this pattern : "+e)}),i.promise},q=function(e,r,n){var o,i,u,s,l,p,c,f,m,v;for(null==n&&(n=[]),p=t.defer(),o=(r+"").split("{")[0],a&&K.log("execute ".yellow+o+" sur chaque élément de la liste fournie.".yellow),l=[],u=c=0,m=e.length-1;m>=0?m>=c:c>=m;u=m>=0?++c:--c){for(s=[e[u]],i=f=0,v=n.length-1;v>=0?v>=f:f>=v;i=v>=0?++f:--f)s.push(n[i]);l.push(r.apply(null,s))}return t.all(l).then(function(){return p.resolve(o)}),p.promise},F=function(e){var r;return r=t.defer(),e=k.resolve(".",e),delete require.cache[e],require(e),a&&K.log(e+" rechargé".yellow),r.resolve(e),r.promise},l=function(e,r,t){var n;return null==r&&(r=exports.appSourceDir),null==t&&(t=exports.appCompiledDir),n=p(e,r,t),A(e,n)},A=function(e,r){var t,n;return n=x(e),exports.reglesDeConversion[n]&&(t=exports.reglesDeConversion[n]),T(e,r).then(function(n){return n?(M&&K.log("Compile ".yellow+e+" to ".yellow+r),v(e).then(function(n){var o,i;return i=n,o=t?t.func(i,e):w(i),o.then(function(e){return G(r,e)})})):a?K.log(r+" déjà à jour".grey):void 0})},B=function(e){return A(e[0],e[1])},P=function(e,r,t){var n;return null==r&&(r=exports.appSourceDir),null==t&&(t=exports.appCompiledDir),n=p(e,r,t),E(n)},r=function(e,r,t,n){return this.lastStamp="static var",this.lastFileList=[],Q.watchTree(e,function(o,i,u){return this.lastStamp!==(new Date).toLocaleTimeString()&&(this.lastFileList=[]),this.lastStamp=(new Date).toLocaleTimeString(),null===u&&null===i&&o instanceof Object?a?K.log("Finished walking ".cyan+e+" tree".cyan):void 0:(lastFileList[o]?a&&K.log(("echo "+o).grey):null===u?(M&&K.log("new ".green+o),t(o)):0===i.nlink?(M&&K.log("rm ".red+o),n(o)):(M&&K.log("change ".yellow+o),r(o)),this.lastFileList[o]=!0)})},$=function(e){return e&&(e.verbose&&(M=!0),e.veryverbose)?(M=!0,a=!0):void 0},T=function(e,r){var n;return n=t.defer(),t.allSettled([g(e),g(r)]).then(function(e){var r,t;return r="fulfilled"===e[0].state?e[0].value.mtime.getTime():0,t="fulfilled"===e[1].state?e[1].value.mtime.getTime():0,r||t||n.reject(e[0].reason),n.resolve(r>t)}),n.promise},v=function(e,r){return null==r&&(r="utf8"),h(e,r)},G=function(e,r){var t;return t=m(e),S(t).then(function(){return D(e,r)})},w=function(e){var r;return r=t.defer(),r.resolve(e),r.promise},x=function(e){var r;return r=e.split("."),r[r.length-1]},p=function(e,r,t){var n,o,i;return null==r&&(r=exports.appSourceDir),null==t&&(t=exports.appCompiledDir),i=x(e),exports.reglesDeConversion[i]?(o=exports.reglesDeConversion[i],n=b(e,r,t,i,o.finalType)):n=b(e,r,t),n},b=function(e,r,t,n,o){var i,u;return null==n&&(n=""),null==o&&(o=""),i=I(e).replace(r,t),n&&(u=new RegExp("."+n+"$","i"),i=i.replace(u,"."+o),a&&K.log("regexp de changement d'extension : ".cyan+u+" -> ".cyan+"."+o)),i},I=function(e){return e.replace(/\\/g,"/")},c=function(e,r){return setTimeout(r,e)},g=function(e){var r;return r=t.defer(),d.stat(e,function(e,t){return e&&r.reject(e),r.resolve(t)}),r.promise},h=function(e,r){var n;return null==r&&(r="utf8"),n=t.defer(),d.readFile(e,r,function(e,r){return e&&n.reject(e),n.resolve(r)}),n.promise},D=function(e,r){var n;return n=t.defer(),d.writeFile(e,r,function(e){return e&&n.reject(e),n.resolve()}),n.promise},m=function(e){var r;return r=e.split("/"),r.pop(),r.join("/")},E=function(e){var r;return r=t.defer(),L(e,function(t){return t?r.reject(t):(M&&K.log(e+" supprimé".yellow),r.resolve())}),r.promise},S=function(e){var r;return r=t.defer(),j(e,function(e){return e&&r.reject(e),r.resolve()}),r.promise},O=function(){return J?(J=!1,exports.testTask(null,exports.watchReporter)):void 0}}).call(this);